# PDF Template System Documentation

## Overview

The PDF template system provides a consistent, reusable structure for generating professional PDF reports with fixed headers, footers, and proper pagination support. The system uses DomPDF with custom `page_script` callbacks to ensure headers and footers appear correctly on all pages.

## Architecture

### Template Structure

```
resources/views/pdf/
├── layouts/
│   └── base.blade.php                    # Base layout with header/footer space
├── reports/
│   └── transaction-report.blade.php     # Transaction report template
└── partials/                              # Reusable partials (if needed)
    ├── header.blade.php
    └── footer.blade.php
```

### Key Components

1. **Base Layout** (`pdf.layouts.base`)
   - Defines page margins for header/footer space
   - Provides content container
   - Handles pagination CSS rules
   - White background throughout

2. **Report Templates** (`pdf.reports.*`)
   - Extend base layout
   - Define report-specific content
   - Use semantic CSS classes
   - Support pagination

3. **PdfService** (`app/Pdf/PdfService.php`)
   - Generates PDF from Blade views
   - Draws header/footer via `page_script` callback
   - Handles vessel information, titles, generation details
   - Manages page numbering
   - Draws logo image in header

## Header System

### How It Works

The header is drawn directly onto the PDF canvas using DomPDF's `page_script` callback. This ensures:
- Header appears on **every page**
- Fixed position at top
- Consistent styling across pages
- No content overlap

### Header Content (Drawn by PdfService)

1. **Logo** - Company logo image (bindamy-marea-logo-light.png) at 140pt width
2. **Vessel Information** (separate lines):
   - Vessel: [name]
   - Registration: [number]
   - Type: [type]
3. **Report Title** - Black, bold, 12pt
4. **Subtitle** - Black, regular, 8pt
5. **Generation Info** (right side):
   - Generated: [date/time]
   - Generated by: [user name]
   - Email: [user email]

### Header Spacing

- Logo size: 140pt width (maintains aspect ratio, ~26pt height)
- Space after logo: 20pt
- Space between vessel lines: 12pt
- Space after vessel type: 16pt (before title)
- Space after title: 16pt
- Space after subtitle: 14pt

### CSS Configuration

```css
@page {
    margin-top: 35mm !important; /* Reserve space for header on ALL pages */
    margin-left: 5mm;
    margin-right: 5mm;
}

@page:first {
    margin-top: 30mm !important; /* Less margin on first page (header is smaller) */
    margin-bottom: 20mm !important; /* Extra footer space on first page */
}
```

## Footer System

### How It Works

The footer is drawn directly onto the PDF canvas using DomPDF's `page_script` callback, positioned at the bottom of each page.

### Footer Content (Drawn by PdfService)

**Left Side:**
- "Bindamy Mareas © [year] All rights reserved"

**Right Side:**
- "Page [current] of [total] | Generated on [date/time]"

### Footer Spacing

- Position: 10mm from bottom (28pt from page bottom)
- First page: 20mm margin-bottom (prevents content overlap)
- Subsequent pages: 10mm margin-bottom

### CSS Configuration

```css
@page {
    margin-bottom: 10mm !important; /* Footer space for subsequent pages */
}

@page:first {
    margin-bottom: 20mm !important; /* Extra space on first page */
}
```

## Body Content

### Content Container

All report content goes inside the `@section('content')` block:

```blade
@extends('pdf.layouts.base')

@section('content')
    <div class="report-content">
        <!-- Your content here -->
    </div>
@endsection
```

### Spacing Rules

1. **First Page Spacing:**
   - `.content-spacer`: 8mm gap between header and content
   - `.report-content margin-top`: 5mm additional spacing
   - Period section: 2px margin-top (close to subtitle)
   - **Total gap: ~13mm** between header subtitle and body content

2. **Subsequent Pages Spacing:**
   - `@page margin-top`: 35mm (more than first page)
   - Table header padding: 30px when appearing on new pages
   - **Total gap: ~45.5mm** between header and table content

3. **Section Spacing:**
   - Use consistent margins (2px, 5px, 8px, 10px, 14px)
   - Maintain white backgrounds throughout
   - All sections left-aligned with header text

4. **Table Spacing:**
   - Tables can break across pages
   - Headers repeat on new pages automatically
   - Use `page-break-inside: auto` for rows
   - Table headers have 30px top padding on new pages to prevent header overlap

## Alignment System

### First Page Alignment

**Critical:** All body content must align with header text on the first page.

- Header text is drawn at `leftX = 14pt` (matches 5mm page margin)
- All body elements must have:
  ```css
  padding-left: 0 !important;
  margin-left: 0 !important;
  ```
- This ensures Period, Summary, and Transactions align perfectly with "Transaction Report" title

### Alignment Rules

```css
/* Force all content to start at page margin */
.content > * {
    margin-left: 0 !important;
    padding-left: 0 !important;
}

.report-content > * {
    margin-left: 0 !important;
    padding-left: 0 !important;
}
```

## Pagination

### How It Works

DomPDF automatically handles pagination based on:
- Page margins (header/footer space)
- Content height
- Page break rules

### Page Break Rules

**Avoid Breaks:**
```css
.page-break-avoid {
    page-break-after: avoid;
    page-break-inside: avoid;
}
```

**Force Breaks:**
```css
.page-break {
    page-break-after: always;
}
```

**Table Pagination:**
```css
table {
    page-break-inside: auto; /* Allow table to break */
}

thead {
    display: table-header-group; /* Repeat header on new pages */
}

tr {
    page-break-inside: auto; /* Allow rows to break */
}
```

### Table Header Repetition

Table headers automatically repeat on new pages when using:
```css
thead {
    display: table-header-group;
}

thead tr:first-child th {
    padding-top: 30px !important; /* Prevent header overlap on new pages */
}
```

## Creating a New Report Template

### Step 1: Create Template File

Create a new file in `resources/views/pdf/reports/`:

```blade
{{-- resources/views/pdf/reports/my-report.blade.php --}}
@extends('pdf.layouts.base')

@section('title', $title ?? 'My Report')

@section('content')
    <div class="report-content">
        <!-- Your report content -->
    </div>
@endsection

@push('styles')
    <style>
        /* Your custom styles */
        .report-content > * {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
    </style>
@endpush
```

### Step 2: Generate PDF

Use `PdfService::generate()`:

```php
use App\Pdf\PdfService;

$pdf = PdfService::generate('pdf.reports.my-report', [
    'title' => 'My Report Title',
    'subtitle' => 'Report Subtitle',
    'vessel' => $vessel,
    // ... other data
]);

return $pdf->stream('my-report.pdf');
```

### Step 3: Required Variables

**Always Required:**
- `$vessel` - Vessel model instance (for header)

**Optional:**
- `$title` - Report title (default: from config)
- `$subtitle` - Report subtitle
- `$user` - User model (for generation info)

## Styling Guidelines

### Colors

- **Background:** Always `#fff` (white)
- **Text:** `#000` (black) for main content
- **Labels:** `#000` (black) for all labels (Period, Summary labels, etc.)
- **Logo:** Company logo image (bindamy-marea-logo-light.png)

### Typography

- **Base Font:** 'DejaVu Sans', 'Helvetica', 'Arial', sans-serif
- **Base Size:** 10px
- **Letter Spacing:** 0.05em (for readability)
- **Line Height:** 1.4-1.6 (depending on context)

### Spacing

- **Small:** 2-5px
- **Medium:** 8-10px
- **Large:** 12-14px
- **Extra Large:** 16-20px

### Tables

- **Header Background:** White (`#fff`)
- **Row Background:** White (`#fff`)
- **Borders:** `1px solid #ddd` for separators
- **Cell Padding:** 8px 6px

## Best Practices

### 1. Always Use White Backgrounds

```css
background-color: #fff; /* Explicit white background */
```

### 2. Use Semantic CSS Classes

```blade
<div class="report-content">
    <div class="period-section">
        <p class="period-text">...</p>
    </div>
</div>
```

### 3. Support Pagination

- Use `page-break-inside: auto` for tables
- Use `display: table-header-group` for thead
- Avoid `page-break-inside: avoid` on large sections
- Table headers need 30px top padding on new pages

### 4. Consistent Spacing

- Use the spacing scale (2px, 5px, 8px, 10px, 12px, 14px, 16px)
- Maintain consistent margins between sections
- First page: ~13mm gap between header and body
- Subsequent pages: ~45.5mm gap between header and body

### 5. Left Alignment

**Critical for first page alignment:**
- All body content must have `padding-left: 0 !important` and `margin-left: 0 !important`
- This ensures Period, Summary, and Transactions align with header text
- Header text is drawn at `leftX = 14pt` (matches 5mm page margin)

### 6. Money Formatting

Always use `MoneyAction::format()`:

```php
{{ MoneyAction::format($amount, 2, $currency, true) }}
```

## Common Patterns

### Period Display

```blade
@if(isset($startDate) && isset($endDate))
    <strong>Period:</strong> 
    {{ \Carbon\Carbon::parse($startDate)->format('d/m/Y') }} - 
    {{ \Carbon\Carbon::parse($endDate)->format('d/m/Y') }}
@endif
```

### Summary Section

```blade
<div class="summary-section">
    <h3 class="section-title">Summary</h3>
    <table class="summary-table">
        <!-- Summary content -->
    </table>
</div>
```

### Data Table

```blade
<table class="data-table">
    <thead>
        <tr>
            <th>Column 1</th>
            <th>Column 2</th>
        </tr>
    </thead>
    <tbody>
        @foreach($items as $item)
            <tr>
                <td>{{ $item->field1 }}</td>
                <td>{{ $item->field2 }}</td>
            </tr>
        @endforeach
    </tbody>
</table>
```

## Email Integration

### Generating PDF for Email

```php
use App\Pdf\PdfService;
use Illuminate\Support\Facades\Mail;

// Generate PDF
$pdf = PdfService::generate('pdf.reports.transaction-report', [
    'vessel' => $vessel,
    'transactions' => $transactions,
    'summary' => $summary,
    'title' => 'Monthly Transaction Report',
    'subtitle' => 'November 2025',
]);

// Save to storage
$pdfPath = PdfService::save('pdf.reports.transaction-report', [
    'vessel' => $vessel,
    'transactions' => $transactions,
    'summary' => $summary,
], "reports/transaction_report_{$vessel->id}.pdf");

// Attach to email
Mail::to($user->email)->send(new TransactionReportMail($pdfPath));
```

## Troubleshooting

### Header Not Appearing

- Check that `PdfService` is using `page_script` callback
- Verify `@page margin-top` is set correctly (35mm for subsequent pages, 30mm for first page)
- Ensure header is drawn in `page_script`, not HTML
- Check logo file exists at `public/bindamy-marea-logo-light.png`

### Footer Overlapping Content

- Increase `@page:first margin-bottom` (currently 20mm)
- Check content doesn't extend too far down
- Verify footer Y position in `page_script`

### Table Headers Not Repeating

- Use `display: table-header-group` on `thead`
- Ensure `thead` is direct child of `table`
- Check for CSS conflicts
- Table headers need 30px top padding on new pages to prevent overlap

### Alignment Issues on First Page

- Ensure all body elements have `padding-left: 0 !important` and `margin-left: 0 !important`
- Check that `.report-content > *` has no left margin/padding
- Verify header text is drawn at `leftX = 14pt` (matches 5mm page margin)
- All sections (Period, Summary, Transactions) should align with header text

### White Background Issues

- Explicitly set `background-color: #fff` on all elements
- Check `@page background: #fff`
- Verify `html` and `body` have white backgrounds

### Logo Not Appearing

- Verify logo file exists: `public/bindamy-marea-logo-light.png`
- Check file permissions
- Logo size is 140pt width (maintains aspect ratio)
- Falls back to text if logo file not found

## Migration from Old Templates

If you have existing templates using `pdf.layouts.default`:

1. **Rename:** Change `@extends('pdf.layouts.default')` to `@extends('pdf.layouts.base')`
2. **Update Styles:** Move inline styles to `@push('styles')` section
3. **Use Classes:** Replace inline styles with semantic CSS classes
4. **Fix Alignment:** Add `padding-left: 0 !important` and `margin-left: 0 !important` to all body elements
5. **Test:** Verify header/footer appear on all pages and alignment is correct

## Examples

### Transaction Report

See `resources/views/pdf/reports/transaction-report.blade.php` for a complete example.

### Custom Report

```blade
@extends('pdf.layouts.base')

@section('title', 'Custom Report')

@section('content')
    <div class="report-content">
        <div class="section">
            <h2>Section Title</h2>
            <p>Content here...</p>
        </div>
    </div>
@endsection

@push('styles')
    <style>
        .report-content > * {
            margin-left: 0 !important;
            padding-left: 0 !important;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section h2 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
@endpush
```

## Support

For questions or issues with the PDF template system:
1. Check this documentation
2. Review existing templates in `resources/views/pdf/reports/`
3. Check `app/Pdf/PdfService.php` for header/footer implementation
